# IDF Switch Configuration
# ════════════════════════════════════════════════════════════════════════════
#
# INHERITANCE MODEL:
#   Layer 1 (Base):     all.yml → disconet.* (DNS, NTP, syslog)
#                       networks.yml → vlans.* (VLAN definitions)
#   Layer 2 (Type):     zyxel.yml → zyxel_base_config (common Zyxel settings)
#   Layer 3 (Delta):    THIS FILE → idf_switch_delta (ports, memberships)
#   Layer 4 (Host):     host_vars/sw-idf*.yml → host-specific overrides
#
# AUTHORITATIVE SOURCES:
#   - VLAN IDs/names/subnets: networks.yml (vlans.*)
#   - DNS/NTP/syslog: all.yml (disconet.*)
#   - Port configs/memberships: THIS FILE (pulled from golden device)
#
# Golden source: sw-idf1.disconet.work
# Pull date: 20260119-111304
# Switch model: GS1920-24HP
# ════════════════════════════════════════════════════════════════════════════
---

# Model type for httpapi plugin (GS1920 series)
ansible_zyxel_model: gs1920

# ============================================================================
# LAYER 3: IDF SWITCH DELTA (Device-type-specific configuration)
# ============================================================================
# This section defines WHAT is configured, referencing WHERE from inventory.
# The sync playbook merges this with base config from Layer 1 & 2.

idf_switch_delta:
  _meta:
    source_switch: "sw-idf1.disconet.work"
    pulled_at: "20260119-111304"
    switch_model: "GS1920-24HP"

  # ─────────────────────────────────────────────────────────────────────────
  # VLAN Selection: Which VLANs from networks.yml are needed on this switch type
  # The actual VLAN IDs/names come from vlans.* at runtime
  # ─────────────────────────────────────────────────────────────────────────
  required_vlan_keys:
    - core        # vlans.core.id = 1
    - internal    # vlans.internal.id = 102
    - public      # vlans.public.id = 103
    - wifiadmin   # vlans.wifiadmin.id = 104
    - admin       # vlans.admin.id = 105
    - jtw         # vlans.jtw.id = 116
    - cfp         # vlans.cfp.id = 117
    - speaker     # vlans.speaker.id = 119
    - registration  # vlans.registration.id = 120
    - open        # vlans.open.id = 228
    - wpa         # vlans.wpa.id = 292

  # Computed at runtime: required_vlans derived from networks.yml
  # Usage in playbooks: {{ idf_switch_config.required_vlans }}

  # ─────────────────────────────────────────────────────────────────────────
  # PORT CONFIGURATION (pulled from golden device)
  # Descriptions, enabled state, speed settings
  # ─────────────────────────────────────────────────────────────────────────
  ports:
    "1":
      enabled: true
      name: "AP"
      speed: "auto"
    "10":
      enabled: true
      name: "AP"
      speed: "auto"
    "11":
      enabled: true
      name: "AP"
      speed: "auto"
    "12":
      enabled: true
      name: "AP"
      speed: "auto"
    "13":
      enabled: true
      name: "AP"
      speed: "auto"
    "14":
      enabled: true
      name: "AP"
      speed: "auto"
    "15":
      enabled: true
      name: "AP"
      speed: "auto"
    "16":
      enabled: true
      name: "AP"
      speed: "auto"
    "17":
      enabled: true
      name: "AP"
      speed: "auto"
    "18":
      enabled: true
      name: "AP"
      speed: "auto"
    "19":
      enabled: true
      name: "POD"
      speed: "auto"
    "2":
      enabled: true
      name: "AP"
      speed: "auto"
    "20":
      enabled: true
      name: "POD"
      speed: "auto"
    "21":
      enabled: true
      name: "POD"
      speed: "auto"
    "22":
      enabled: true
      name: "POD"
      speed: "auto"
    "23":
      enabled: true
      name: "POD"
      speed: "auto"
    "24":
      enabled: true
      name: "POD"
      speed: "auto"
    "25":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "26":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "27":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "28":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "3":
      enabled: true
      name: "AP"
      speed: "auto"
    "4":
      enabled: true
      name: "AP"
      speed: "auto"
    "5":
      enabled: true
      name: "AP"
      speed: "auto"
    "6":
      enabled: true
      name: "AP"
      speed: "auto"
    "7":
      enabled: true
      name: "AP"
      speed: "auto"
    "8":
      enabled: true
      name: "AP"
      speed: "auto"
    "9":
      enabled: true
      name: "AP"
      speed: "auto"

  # ─────────────────────────────────────────────────────────────────────────
  # PORT VLAN SETTINGS (pulled from golden device)
  # PVID, trunking, ingress filtering
  # Note: PVID values reference VLAN IDs from networks.yml
  # ─────────────────────────────────────────────────────────────────────────
  port_vlan_settings:
    "1":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "10":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "11":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "12":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "13":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "14":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "15":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "16":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "17":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "18":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "19":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "2":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "20":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "21":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "22":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "23":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "24":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "25":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "26":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "27":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "28":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "3":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "4":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "5":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "6":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "7":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "8":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"
    "9":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
      acceptable_frame_type: "all"

  # ─────────────────────────────────────────────────────────────────────────
  # VLAN PORT MEMBERSHIP (pulled from golden device)
  # Defines which ports are untagged/tagged for each VLAN
  # VLAN IDs here match vlans.*.id from networks.yml
  # ─────────────────────────────────────────────────────────────────────────
  vlan_port_membership:
    "1":
      name: "CORE"
      untagged_ports: ["20", "21", "22", "23", "24", "25", "26", "27", "28"]
    "102":
      name: "INT"
    "103":
      name: "PUB"
    "104":
      name: "WIFIADMIN"
      untagged_ports: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"]
    "105":
      name: "SYNC"
    "116":
      name: "JTW"
    "117":
      name: "CFP"
    "119":
      name: "SPEAKER"
    "120":
      name: "REG"
    "228":
      name: "OPEN"
    "292":
      name: "WPA"

  # ─────────────────────────────────────────────────────────────────────────
  # MANAGEMENT SETTINGS
  # ─────────────────────────────────────────────────────────────────────────
  management:
    vlan: "{{ vlans.core.id }}"
    ssh: true
    https: true
    snmp: true
    syslog: true

  # ─────────────────────────────────────────────────────────────────────────
  # SPANNING TREE SETTINGS
  # ─────────────────────────────────────────────────────────────────────────
  spanning_tree:
    mode: rstp
    priority: 32768
    edge_ports: "1-19"

# ============================================================================
# COMPUTED CONFIG: Runtime merge of base + delta for sync playbooks
# ============================================================================
# Usage: {{ idf_switch_config.ntp_servers }}, {{ idf_switch_config.required_vlans }}

idf_switch_config:
  # ─── Base Settings (from all.yml via disconet.*) ───
  ntp_servers: "{{ disconet.ntp_servers }}"
  syslog_server: "{{ disconet.syslog_server }}"
  domain: "{{ disconet.domain }}"

  # ─── VLANs: Resolved from delta.required_vlan_keys + networks.yml ───
  # Each item has: id, name, subnet, etc. from networks.yml
  required_vlans: >-
    {%- set result = [] -%}
    {%- for key in idf_switch_delta.required_vlan_keys -%}
      {%- if key in vlans -%}
        {%- set _ = result.append(vlans[key] | combine({'key': key})) -%}
      {%- endif -%}
    {%- endfor -%}
    {{ result }}

  # ─── Delta Config (passthrough for sync playbooks) ───
  ports: "{{ idf_switch_delta.ports }}"
  port_vlan_settings: "{{ idf_switch_delta.port_vlan_settings }}"
  vlan_port_membership: "{{ idf_switch_delta.vlan_port_membership }}"
  management: "{{ idf_switch_delta.management }}"
  spanning_tree: "{{ idf_switch_delta.spanning_tree }}"

