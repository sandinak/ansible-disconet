# Podium Switch Configuration
# ════════════════════════════════════════════════════════════════════════════
#
# INHERITANCE MODEL:
#   Layer 1 (Base):     all.yml → disconet.* (DNS, NTP, syslog)
#                       networks.yml → vlans.* (VLAN definitions)
#   Layer 2 (Type):     zyxel.yml → zyxel_base_config (common Zyxel settings)
#   Layer 3 (Delta):    THIS FILE → podium_switch_delta (ports, memberships)
#   Layer 4 (Host):     host_vars/sw-pod*.yml → host-specific overrides
#
# AUTHORITATIVE SOURCES:
#   - VLAN IDs/names/subnets: networks.yml (vlans.*)
#   - DNS/NTP/syslog: all.yml (disconet.*)
#   - Port configs/memberships: THIS FILE (pulled from golden device)
#
# Golden source: sw-pod1.disconet.work
# Pull date: 20260119-170309
# Switch model: GS1900-8HP
# ════════════════════════════════════════════════════════════════════════════
---

# Switch model for httpapi connection
ansible_zyxel_model: gs1900

# ============================================================================
# LAYER 3: PODIUM SWITCH DELTA (Device-type-specific configuration)
# ============================================================================
# This section defines WHAT is configured, referencing WHERE from inventory.
# The sync playbook merges this with base config from Layer 1 & 2.

podium_switch_delta:
  _meta:
    source_switch: "sw-pod1.disconet.work"
    pulled_at: "20260119-170309"
    switch_model: "GS1900-8HP"

  # ─────────────────────────────────────────────────────────────────────────
  # VLAN Selection: Which VLANs from networks.yml are needed on this switch type
  # The actual VLAN IDs/names come from vlans.* at runtime
  # ─────────────────────────────────────────────────────────────────────────
  required_vlan_keys:
    - core        # vlans.core.id = 1
    - wifiadmin   # vlans.wifiadmin.id = 104
    - jtw         # vlans.jtw.id = 116
    - cfp         # vlans.cfp.id = 117
    - junk        # vlans.junk.id = 118
    - speaker     # vlans.speaker.id = 119
    - registration  # vlans.registration.id = 120
    - vov         # vlans.vov.id = 121
    - open        # vlans.open.id = 228
    - wpa         # vlans.wpa.id = 292

  # ─────────────────────────────────────────────────────────────────────────
  # PORT CONFIGURATION (pulled from golden device)
  # Descriptions, enabled state, speed settings
  # ─────────────────────────────────────────────────────────────────────────
  ports:
    "1":
      enabled: true
      name: "WAP"
      speed: "auto"
    "2":
      enabled: true
      name: "SPEAKER"
      speed: "auto"
    "3":
      enabled: true
      name: "SPEAKER"
      speed: "auto"
    "4":
      enabled: true
      name: "SPEAKER"
      speed: "auto"
    "5":
      enabled: true
      name: "WIFI"
      speed: "auto"
    "6":
      enabled: true
      name: "WIFI"
      speed: "auto"
    "7":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "8":
      enabled: true
      name: "TRUNK"
      speed: "auto"

  # ─────────────────────────────────────────────────────────────────────────
  # PORT VLAN SETTINGS (pulled from golden device)
  # PVID, trunking, ingress filtering
  # Note: PVID values reference VLAN IDs from networks.yml
  # ─────────────────────────────────────────────────────────────────────────
  port_vlan_settings:
    "1":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
    "2":
      pvid: 119
      vlan_trunking: false
      ingress_filtering: false
    "3":
      pvid: 119
      vlan_trunking: false
      ingress_filtering: false
    "4":
      pvid: 119
      vlan_trunking: false
      ingress_filtering: false
    "5":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
    "6":
      pvid: 104
      vlan_trunking: true
      ingress_filtering: false
    "7":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false
    "8":
      pvid: 1
      vlan_trunking: true
      ingress_filtering: false

  # ─────────────────────────────────────────────────────────────────────────
  # VLAN PORT MEMBERSHIP (pulled from golden device)
  # tagged_ports = trunk ports carrying this VLAN tagged
  # untagged_ports = access ports with this VLAN as native (PVID)
  # forbidden_ports = ports explicitly forbidden from this VLAN
  # VLAN IDs here match vlans.*.id from networks.yml
  # ─────────────────────────────────────────────────────────────────────────
  vlan_port_membership:
    "1":
      name: "CORE"
      tagged_ports: []
      untagged_ports: ["7", "8"]
      forbidden_ports: []
    "104":
      name: "WIFIADMIN"
      tagged_ports: ["7", "8"]
      untagged_ports: ["1", "5", "6"]
      forbidden_ports: ["2", "3", "4"]
    "116":
      name: "JTW"
      tagged_ports: ["1", "5", "6", "7", "8"]
      untagged_ports: []
      forbidden_ports: ["2", "3", "4"]
    "117":
      name: "CFP"
      tagged_ports: []
      untagged_ports: []
      forbidden_ports: ["1", "2", "3", "4", "5", "6", "7", "8"]
    "118":
      name: "JUNK"
      tagged_ports: ["1", "5", "6", "7", "8"]
      untagged_ports: []
      forbidden_ports: ["2", "3", "4"]
    "119":
      name: "SPEAKER"
      tagged_ports: ["1", "5", "6", "7", "8"]
      untagged_ports: ["2", "3", "4"]
      forbidden_ports: []
    "120":
      name: "REG"
      tagged_ports: []
      untagged_ports: []
      forbidden_ports: ["1", "2", "3", "4", "5", "6", "7", "8"]
    "121":
      name: "VOV"
      tagged_ports: ["1", "5", "6", "7", "8"]
      untagged_ports: []
      forbidden_ports: ["2", "3", "4"]
    "228":
      name: "OPEN"
      tagged_ports: []
      untagged_ports: []
      forbidden_ports: ["1", "2", "3", "4", "5", "6", "7", "8"]
    "292":
      name: "WPA"
      tagged_ports: []
      untagged_ports: []
      forbidden_ports: ["1", "2", "3", "4", "5", "6", "7", "8"]

  # ─────────────────────────────────────────────────────────────────────────
  # MANAGEMENT SETTINGS
  # ─────────────────────────────────────────────────────────────────────────
  management:
    vlan: "{{ vlans.core.id }}"
    ssh: true
    https: true
    snmp: true
    syslog: true

  # ─────────────────────────────────────────────────────────────────────────
  # SPANNING TREE SETTINGS
  # ─────────────────────────────────────────────────────────────────────────
  spanning_tree:
    mode: rstp
    priority: 32768
    edge_ports: "1-8"

# ============================================================================
# COMPUTED CONFIG: Runtime merge of base + delta for sync playbooks
# ============================================================================
# Usage: {{ podium_switch_config.ntp_servers }}, {{ podium_switch_config.required_vlans }}

podium_switch_config:
  # ─── Base Settings (from all.yml via disconet.*) ───
  ntp_servers: "{{ disconet.ntp_servers }}"
  syslog_server: "{{ disconet.syslog_server }}"
  domain: "{{ disconet.domain }}"

  # ─── VLANs: Resolved from delta.required_vlan_keys + networks.yml ───
  # Each item has: id, name, subnet, etc. from networks.yml
  required_vlans: >-
    {%- set result = [] -%}
    {%- for key in podium_switch_delta.required_vlan_keys -%}
      {%- if key in vlans -%}
        {%- set _ = result.append(vlans[key] | combine({'key': key})) -%}
      {%- endif -%}
    {%- endfor -%}
    {{ result }}

  # ─── Delta Config (passthrough for sync playbooks) ───
  ports: "{{ podium_switch_delta.ports }}"
  port_vlan_settings: "{{ podium_switch_delta.port_vlan_settings }}"
  vlan_port_membership: "{{ podium_switch_delta.vlan_port_membership }}"
  management: "{{ podium_switch_delta.management }}"
  spanning_tree: "{{ podium_switch_delta.spanning_tree }}"

