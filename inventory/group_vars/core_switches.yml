# Core Switch Configuration
# ════════════════════════════════════════════════════════════════════════════
#
# INHERITANCE MODEL:
#   Layer 1 (Base):     all.yml → disconet.* (DNS, NTP, syslog)
#                       networks.yml → vlans.* (VLAN definitions)
#   Layer 2 (Type):     zyxel.yml → zyxel_base_config (common Zyxel settings)
#   Layer 3 (Delta):    THIS FILE → core_switch_delta (ports, memberships)
#   Layer 4 (Host):     host_vars/sw-core*.yml → host-specific overrides
#
# AUTHORITATIVE SOURCES:
#   - VLAN IDs/names/subnets: networks.yml (vlans.*)
#   - DNS/NTP/syslog: all.yml (disconet.*)
#   - Port configs/memberships: THIS FILE (pulled from golden device)
#
# Golden source: sw-core1.disconet.work
# Pull date: 20260119-122643
# Switch model: GS1915-24EP
# ════════════════════════════════════════════════════════════════════════════
---

# Model identifier for httpapi plugin
ansible_zyxel_model: gs1915

# ============================================================================
# LAYER 3: CORE SWITCH DELTA (Device-type-specific configuration)
# ============================================================================
# This section defines WHAT is configured, referencing WHERE from inventory.
# The sync playbook merges this with base config from Layer 1 & 2.

core_switch_delta:
  _meta:
    source_switch: "sw-core1.disconet.work"
    pulled_at: "20260119-122643"
    switch_model: "GS1915-24EP"

  # ─────────────────────────────────────────────────────────────────────────
  # VLAN Selection: Which VLANs from networks.yml are needed on this switch type
  # The actual VLAN IDs/names come from vlans.* at runtime
  # ─────────────────────────────────────────────────────────────────────────
  required_vlan_keys:
    - core        # vlans.core.id = 1
    - public      # vlans.public.id = 103
    - wifiadmin   # vlans.wifiadmin.id = 104
    - admin       # vlans.admin.id = 105
    - cfp         # vlans.cfp.id = 117
    - speaker     # vlans.speaker.id = 119
    - registration  # vlans.registration.id = 120
    - vov         # vlans.vov.id = 121
    - open        # vlans.open.id = 228
    - wpa         # vlans.wpa.id = 292

  # ─────────────────────────────────────────────────────────────────────────
  # PORT CONFIGURATION (pulled from golden device)
  # Descriptions, enabled state, speed settings
  # ─────────────────────────────────────────────────────────────────────────
  ports:
    "1":
      enabled: true
      name: "FW1"
      speed: "auto"
    "10":
      enabled: true
      name: "WADMIN"
      speed: "auto"
    "11":
      enabled: true
      name: "WADMIN"
      speed: "auto"
    "12":
      enabled: true
      name: "WADMIN"
      speed: "auto"
    "13":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "14":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "15":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "16":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "17":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "18":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "19":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "2":
      enabled: true
      name: "FW2"
      speed: "auto"
    "20":
      enabled: true
      name: "ADMIN"
      speed: "auto"
    "21":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "22":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "23":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "24":
      enabled: true
      name: "TRUNK"
      speed: "auto"
    "3":
      enabled: true
      name: "HOUSE"
      speed: "auto"
    "4":
      enabled: true
      name: "PVE"
      speed: "auto"
    "5":
      enabled: true
      name: ""
      speed: "auto"
    "6":
      enabled: true
      name: ""
      speed: "auto"
    "7":
      enabled: true
      name: "WADMIN"
      speed: "auto"
    "8":
      enabled: true
      name: "WADMIN"
      speed: "auto"
    "9":
      enabled: true
      name: "WADMIN"
      speed: "auto"

  # ─────────────────────────────────────────────────────────────────────────
  # PORT VLAN SETTINGS (pulled from golden device)
  # PVID, trunking, ingress filtering
  # Note: PVID values reference VLAN IDs from networks.yml
  # ─────────────────────────────────────────────────────────────────────────
  port_vlan_settings:
    "1":
      pvid: 1
      vlan_trunking: true
    "10":
      pvid: 104
      vlan_trunking: true
    "11":
      pvid: 104
      vlan_trunking: true
    "12":
      pvid: 104
      vlan_trunking: true
    "13":
      pvid: 105
      vlan_trunking: false
    "14":
      pvid: 105
      vlan_trunking: false
    "15":
      pvid: 105
      vlan_trunking: false
    "16":
      pvid: 105
      vlan_trunking: false
    "17":
      pvid: 105
      vlan_trunking: false
    "18":
      pvid: 105
      vlan_trunking: false
    "19":
      pvid: 105
      vlan_trunking: false
    "2":
      pvid: 1
      vlan_trunking: true
    "20":
      pvid: 1
      vlan_trunking: true
    "21":
      pvid: 1
      vlan_trunking: true
    "22":
      pvid: 1
      vlan_trunking: true
    "23":
      pvid: 1
      vlan_trunking: true
    "24":
      pvid: 1
      vlan_trunking: true
    "3":
      pvid: 1
      vlan_trunking: true
    "4":
      pvid: 1
      vlan_trunking: true
    "5":
      pvid: 1
      vlan_trunking: true
    "6":
      pvid: 1
      vlan_trunking: true
    "7":
      pvid: 104
      vlan_trunking: true
    "8":
      pvid: 104
      vlan_trunking: true
    "9":
      pvid: 104
      vlan_trunking: true

  # ─────────────────────────────────────────────────────────────────────────
  # VLAN PORT MEMBERSHIP (pulled from golden device)
  # tagged_ports = Fixed + TX tagged (trunk)
  # untagged_ports = Fixed + TX untagged (access)
  # VLAN IDs here match vlans.*.id from networks.yml
  # ─────────────────────────────────────────────────────────────────────────
  vlan_port_membership:
    "1":
      name: "CORE"
      tagged_ports: []
      untagged_ports: ["1", "2", "3", "4", "5", "6", "21", "22", "23", "24"]
    "103":
      name: "PUB"
      tagged_ports: ["1", "2", "3", "4", "5", "6", "7", "8", "21", "22", "23", "24"]
      untagged_ports: []
    "104":
      name: "WIFIADMIN"
      tagged_ports: ["1", "2", "21", "22", "23", "24"]
      untagged_ports: ["7", "8", "9", "10", "11", "12"]
    "105":
      name: "ADMIN"
      tagged_ports: ["1", "2"]
      untagged_ports: ["13", "14", "15", "16", "17", "18", "19", "20"]
    "117":
      name: "CFP"
      tagged_ports: ["1", "2", "21", "22", "23", "24"]
      untagged_ports: []
    "119":
      name: "SPEAKER"
      tagged_ports: ["1", "2", "7", "8", "9", "10", "11", "12", "21", "22", "23", "24"]
      untagged_ports: []
    "120":
      name: "REG"
      tagged_ports: ["1", "2", "21", "22", "23", "24"]
      untagged_ports: []
    "121":
      name: "VOV"
      tagged_ports: ["1", "2", "7", "8", "9", "10", "11", "12", "21", "22", "23", "24"]
      untagged_ports: []
    "228":
      name: "OPEN"
      tagged_ports: ["1", "2", "3", "4", "9", "10", "11", "12", "21", "22", "23", "24"]
      untagged_ports: []
    "292":
      name: "WPA"
      tagged_ports: ["1", "2", "9", "10", "11", "12", "21", "22", "23", "24"]
      untagged_ports: []

  # ─────────────────────────────────────────────────────────────────────────
  # MANAGEMENT SETTINGS
  # ─────────────────────────────────────────────────────────────────────────
  management:
    vlan: "{{ vlans.core.id }}"
    ssh: true
    https: true
    snmp: true
    syslog: true

  # ─────────────────────────────────────────────────────────────────────────
  # SPANNING TREE SETTINGS
  # ─────────────────────────────────────────────────────────────────────────
  spanning_tree:
    mode: rstp
    priority: 32768

# ============================================================================
# COMPUTED CONFIG: Runtime merge of base + delta for sync playbooks
# ============================================================================
# Usage: {{ core_switch_config.ntp_servers }}, {{ core_switch_config.required_vlans }}

core_switch_config:
  # ─── Base Settings (from all.yml via disconet.*) ───
  ntp_servers: "{{ disconet.ntp_servers }}"
  syslog_server: "{{ disconet.syslog_server }}"
  domain: "{{ disconet.domain }}"

  # ─── VLANs: Resolved from delta.required_vlan_keys + networks.yml ───
  # Each item has: id, name, subnet, etc. from networks.yml
  required_vlans: >-
    {%- set result = [] -%}
    {%- for key in core_switch_delta.required_vlan_keys -%}
      {%- if key in vlans -%}
        {%- set _ = result.append(vlans[key] | combine({'key': key})) -%}
      {%- endif -%}
    {%- endfor -%}
    {{ result }}

  # ─── Delta Config (passthrough for sync playbooks) ───
  ports: "{{ core_switch_delta.ports }}"
  port_vlan_settings: "{{ core_switch_delta.port_vlan_settings }}"
  vlan_port_membership: "{{ core_switch_delta.vlan_port_membership }}"
  management: "{{ core_switch_delta.management }}"
  spanning_tree: "{{ core_switch_delta.spanning_tree }}"

