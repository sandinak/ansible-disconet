# zyxel_base role - Basic system configuration
# Uses HTTP API modules for reliable configuration on GS1900/GS1915/GS1920
#
# This role uses the Base + Delta config pattern:
#   - Hostname (from host_vars: switch_hostname)
#   - Location (from host_vars: switch_location)
#   - Contact (from zyxel_config)
#   - NTP/Syslog (from *_switch_config which references disconet.*)
#
# Connection: Requires 'httpapi' connection (set in playbook or group_vars)
---

# ============================================================
# Load switch config based on group membership
# Uses the new *_switch_config computed variables
# ============================================================
- name: Set switch config (IDF switches)
  ansible.builtin.set_fact:
    switch_config: "{{ idf_switch_config | default({}) }}"
  when:
    - "'idf_switches' in group_names"
    - idf_switch_config is defined

- name: Set switch config (Core switches)
  ansible.builtin.set_fact:
    switch_config: "{{ core_switch_config | default({}) }}"
  when:
    - "'core_switches' in group_names"
    - core_switch_config is defined

- name: Set switch config (Podium switches)
  ansible.builtin.set_fact:
    switch_config: "{{ podium_switch_config | default({}) }}"
  when:
    - "'podium_switches' in group_names"
    - podium_switch_config is defined

# ============================================================
# Configure System Settings via HTTP API
# ============================================================
- name: Configure system settings via HTTP API
  network.zyxel.zyxel_system:
    hostname: "{{ switch_hostname | default(inventory_hostname | regex_replace('\\..*$', '')) }}"
    location: "{{ switch_location | default(omit) }}"
    contact: "{{ zyxel_config.system.contact | default('admin@disconet.local') }}"
    ntp_servers: "{{ switch_config.ntp_servers | default(zyxel_config.management.ntp.servers | default(omit)) }}"
    timezone: "{{ zyxel_config.system.timezone | default(omit) }}"
  tags: [zyxel, base, system]

# ============================================================
# Configure Syslog via HTTP API (if module available)
# ============================================================
- name: Configure syslog server
  network.zyxel.zyxel_syslog:
    server: "{{ switch_config.syslog_server | default(zyxel_config.management.syslog.server) }}"
    enabled: true
  when:
    - switch_config.syslog_server is defined or (zyxel_config.management.syslog.enabled | default(false))
  tags: [zyxel, base, syslog]
  ignore_errors: true  # Module may not be fully implemented

# ============================================================
# Display Summary
# ============================================================
- name: Display base configuration summary
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════
      Base configuration applied to {{ inventory_hostname }}
      ═══════════════════════════════════════════════════════════
      Hostname: {{ switch_hostname | default(inventory_hostname | regex_replace('\\..*$', '')) }}
      Location: {{ switch_location | default('not set') }}
      NTP Servers: {{ switch_config.ntp_servers | default('from zyxel_config') }}
      Syslog: {{ switch_config.syslog_server | default('not configured') }}
      Config Source: Base + Delta inheritance model
  tags: [zyxel, base, summary]

