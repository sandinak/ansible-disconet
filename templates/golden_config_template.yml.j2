# Golden Configuration Template - {{ switch_type | upper }} Switches
# Pulled from: {{ inventory_hostname }}
# Pulled at: {{ timestamp }}
#
# This file is auto-generated by pull_golden_config.yml
# Manual edits may be overwritten on next pull.
#
# Host-specific overrides (hostname, IP, etc.) go in host_vars/
---
{{ switch_type }}_switch_template:
  # ============================================================
  # Metadata
  # ============================================================
  _meta:
    source_switch: "{{ inventory_hostname }}"
    source_ip: "{{ ansible_host }}"
    pulled_at: "{{ timestamp }}"

  # ============================================================
  # VLAN Configuration
  # ============================================================
  vlans:
{% for vlan_id, vlan_data in (vlans_info.vlans | default({})).items() | sort %}
    {{ vlan_id }}:
      name: "{{ vlan_data.name | default('VLAN' ~ vlan_id) }}"
{% if vlan_data.ports is defined %}
      ports: {{ vlan_data.ports | to_json }}
{% endif %}
{% endfor %}

  # ============================================================
  # Port Configuration
  # ============================================================
  # Each port includes: enabled, speed, description, link status
  ports:
{% for port_id, port_data in (ports_info.ports | default({})).items() | sort(attribute='0|int') %}
    {{ port_id }}:
      enabled: {{ port_data.enabled | default(true) | lower }}
{% if port_data.speed is defined %}
      speed: "{{ port_data.speed }}"
{% endif %}
{% if port_data.description is defined and port_data.description %}
      description: "{{ port_data.description }}"
{% endif %}
{% endfor %}

  # ============================================================
  # Port VLAN Settings (PVID, Trunking, etc.)
  # ============================================================
  # Each port includes: pvid, vlan_trunking, ingress_filtering
  port_vlan_settings:
{% for port_id, port_data in (vlan_ports_info.ports | default({})).items() | sort(attribute='0|int') %}
    {{ port_id }}:
{% if port_data.pvid is defined %}
      pvid: {{ port_data.pvid }}
{% endif %}
{% if port_data.vlan_trunking is defined %}
      vlan_trunking: {{ port_data.vlan_trunking | lower }}
{% endif %}
{% if port_data.ingress_filtering is defined %}
      ingress_filtering: {{ port_data.ingress_filtering | lower }}
{% endif %}
{% if port_data.acceptable_frame_type is defined %}
      acceptable_frame_type: "{{ port_data.acceptable_frame_type }}"
{% endif %}
{% endfor %}

{% if system_info.system is defined and system_info.system %}
  # ============================================================
  # System Settings
  # ============================================================
  system:
{% if system_info.system.hostname is defined %}
    # hostname excluded - set per-host in host_vars
{% endif %}
{% if system_info.system.timezone is defined %}
    timezone: "{{ system_info.system.timezone }}"
{% endif %}
{% if system_info.system.ntp_server is defined %}
    ntp_server: "{{ system_info.system.ntp_server }}"
{% endif %}
{% endif %}

  # ============================================================
  # Management Settings
  # ============================================================
  management:
    vlan: "{{ '{{' }} vlans.core.id {{ '}}' }}"
    ssh: true
    https: true
    snmp: true
    syslog: true

# ============================================================
# Port Templates (Human-Readable Groupings)
# ============================================================
# These map ports to their logical roles based on the pulled config
port_templates:
{% set ns = namespace(ap_ports=[], podium_ports=[], trunk_ports=[], access_ports=[]) %}
{% for port_id, port_data in (vlan_ports_info.ports | default({})).items() | sort(attribute='0|int') %}
{%   set pvid = port_data.pvid | default(1) | int %}
{%   set trunking = port_data.vlan_trunking | default(false) %}
{# Logic to categorize ports based on PVID and trunking #}
{%   if pvid == vlans.internal.id | default(102) %}
{%     set _ = ns.ap_ports.append(port_id) %}
{%   elif trunking %}
{%     set _ = ns.trunk_ports.append(port_id) %}
{%   elif pvid == vlans.core.id | default(1) %}
{%     set _ = ns.podium_ports.append(port_id) %}
{%   else %}
{%     set _ = ns.access_ports.append(port_id) %}
{%   endif %}
{% endfor %}
  ap_ports: {{ ns.ap_ports | to_json }}
  podium_ports: {{ ns.podium_ports | to_json }}
  trunk_ports: {{ ns.trunk_ports | to_json }}
  access_ports: {{ ns.access_ports | to_json }}

