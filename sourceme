#!/bin/bash
# Disconet Ansible Environment Setup
# Source this file: source sourceme

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="${SCRIPT_DIR}/.venv"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Disconet Ansible Environment ===${NC}"

# Check if we're being sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo -e "${RED}Error: This script must be sourced, not executed.${NC}"
    echo "Usage: source sourceme"
    exit 1
fi

# Change to script directory
cd "$SCRIPT_DIR" || return 1

# Check if venv exists and is up to date
setup_needed=0

if [[ ! -d "$VENV_DIR" ]]; then
    echo -e "${YELLOW}Virtual environment not found. Running setup...${NC}"
    setup_needed=1
elif [[ ! -f "$VENV_DIR/.deps_installed" ]]; then
    echo -e "${YELLOW}Dependencies not installed. Running setup...${NC}"
    setup_needed=1
elif [[ "requirements.txt" -nt "$VENV_DIR/.deps_installed" ]]; then
    echo -e "${YELLOW}requirements.txt changed. Updating dependencies...${NC}"
    setup_needed=1
elif [[ ! -f "$VENV_DIR/.collections_installed" ]]; then
    echo -e "${YELLOW}Collections not installed. Running setup...${NC}"
    setup_needed=1
elif [[ "requirements.yml" -nt "$VENV_DIR/.collections_installed" ]]; then
    echo -e "${YELLOW}requirements.yml changed. Updating collections...${NC}"
    setup_needed=1
fi

# Run make if setup is needed
if [[ $setup_needed -eq 1 ]]; then
    echo -e "${YELLOW}Running make to setup environment...${NC}"
    make all
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}Setup failed! Please check the errors above.${NC}"
        return 1
    fi
fi

# Activate virtual environment
if [[ -f "$VENV_DIR/bin/activate" ]]; then
    source "$VENV_DIR/bin/activate"
    echo -e "${GREEN}Virtual environment activated.${NC}"
else
    echo -e "${RED}Error: Virtual environment not found at $VENV_DIR${NC}"
    return 1
fi

# Set Ansible environment variables
export ANSIBLE_CONFIG="${SCRIPT_DIR}/ansible.cfg"
export ANSIBLE_INVENTORY="${SCRIPT_DIR}/inventory"

# Display environment info
echo ""
echo -e "${GREEN}Environment ready!${NC}"
echo "  Python:  $(python --version 2>&1)"
echo "  Ansible: $(ansible --version | head -1)"
echo "  Config:  $ANSIBLE_CONFIG"
echo "  Inventory: $ANSIBLE_INVENTORY"
echo ""
echo "Quick commands:"
echo "  make ping     - Test connectivity to all hosts"
echo "  make site     - Deploy full configuration"
echo "  make help     - Show all available targets"
echo ""

