---
# Sync Podium Switch Configuration
# Pull config from sw-pod1 (reference) and apply to other podium switches
# This ensures all podium switches have identical port/VLAN configuration
#
# This playbook uses the golden config pattern:
#   1. Backup reference switch config (CLI via network_cli)
#   2. Backup target switches before changes (CLI via network_cli)
#   3. Apply configuration using HTTP API modules (httpapi)
#   4. Save and verify changes (CLI via network_cli)
#
# The actual config template is in group_vars/podium_switches.yml
# To update the golden config from pod1, run:
#   ansible-playbook playbooks/pull_golden_config.yml --limit sw-pod1.disconet.work

# ============================================================
# PLAY 1: Pre-sync confirmation (GS1900 has no CLI, only web interface)
# ============================================================
- name: Pre-sync Confirmation for Podium Switches
  hosts: podium_switches:!sw-pod1.disconet.work
  gather_facts: false
  serial: 1
  vars:
    backup_dir: "{{ playbook_dir }}/../backups/zyxel"
    timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Display pre-sync info
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          Preparing to sync {{ inventory_hostname }}
          ═══════════════════════════════════════════════════════════
          Note: GS1900 switches don't support SSH/CLI, using HTTP API only
          Template: group_vars/podium_switches.yml (from sw-pod1)



# ============================================================
# PLAY 3: Apply Configuration via HTTP API (httpapi)
# ============================================================
- name: Apply Reference Configuration to Other Podium Switches
  hosts: podium_switches:!sw-pod1.disconet.work
  gather_facts: false
  serial: 1  # Apply one at a time for safety
  vars:
    # Override connection to httpapi for HTTP API modules
    ansible_connection: httpapi
    ansible_httpapi_use_ssl: true
    ansible_httpapi_validate_certs: false

  pre_tasks:
    - name: Display sync message
      ansible.builtin.debug:
        msg: |
          Syncing {{ inventory_hostname }} with Podium switch template
          Template source: group_vars/podium_switches.yml
          Management IP: {{ switch_management_ip | default(ansible_host) }}
          Connection: HTTP API (httpapi)

  roles:
    - role: zyxel_base
      tags: [base, system]
    - role: zyxel_vlans
      tags: [vlans]
    - role: zyxel_ports
      tags: [ports]
    - role: zyxel_security
      tags: [security]

# ============================================================
# PLAY 4: Post-sync Summary (GS1900 saves config automatically via web)
# ============================================================
- name: Post-sync Summary for Podium Switches
  hosts: podium_switches:!sw-pod1.disconet.work
  gather_facts: false
  serial: 1

  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ✓ {{ inventory_hostname }} synchronized successfully
          Note: GS1900 saves configuration via web interface automatically

# ============================================================
# PLAY 5: Summary
# ============================================================
- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display sync summary
      ansible.builtin.debug:
        msg: |

          ═══════════════════════════════════════════════════════════
          Podium Switch Configuration Sync Complete
          ═══════════════════════════════════════════════════════════

          Template Source: group_vars/podium_switches.yml
          Reference Switch: sw-pod1.disconet.work
          Target switches: sw-pod2, sw-pod3

          Note: GS1900 switches use HTTP API only (no SSH/CLI)

          ✓ Configuration applied via HTTP API modules:
            - zyxel_base: System settings (hostname, management)
            - zyxel_vlans: VLAN configuration
            - zyxel_ports: Port PVID and VLAN membership
            - zyxel_security: STP and security settings

          To update golden config from reference switch:
            ansible-playbook playbooks/pull_golden_config.yml --limit sw-pod1.disconet.work

          To apply to a single switch:
            ansible-playbook playbooks/sync_podium_switches.yml --limit sw-pod2.disconet.work
