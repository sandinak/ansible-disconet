---
# Pull Golden Configuration from pfSense
# Extracts key configuration sections via PHP shell
#
# Usage:
#   ansible-playbook playbooks/pull_pfsense_golden_config.yml -l pfsense1.disconet.work

- name: Pull Golden Configuration from pfSense
  hosts: pfsense
  gather_facts: false
  vars:
    output_file: "{{ playbook_dir }}/../inventory/group_vars/pfsense_golden.yml"

  tasks:
    - name: Get system configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          echo json_encode(array(
            'hostname' => $config['system']['hostname'],
            'domain' => $config['system']['domain'],
            'timezone' => $config['system']['timezone'],
            'dns_servers' => isset($config['system']['dnsserver']) ? $config['system']['dnsserver'] : array()
          ));
      register: system_config
      changed_when: false

    - name: Get interface configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          $ifaces = array();
          foreach ($config['interfaces'] as $name => $iface) {
            $ifaces[$name] = array(
              'enable' => isset($iface['enable']),
              'descr' => isset($iface['descr']) ? $iface['descr'] : $name,
              'if' => isset($iface['if']) ? $iface['if'] : '',
              'ipaddr' => isset($iface['ipaddr']) ? $iface['ipaddr'] : '',
              'subnet' => isset($iface['subnet']) ? $iface['subnet'] : ''
            );
          }
          echo json_encode($ifaces);
      register: interface_config
      changed_when: false

    - name: Get VLAN configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          echo json_encode(isset($config['vlans']['vlan']) ? $config['vlans']['vlan'] : array());
      register: vlan_config
      changed_when: false

    - name: Get alias configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          echo json_encode(isset($config['aliases']['alias']) ? $config['aliases']['alias'] : array());
      register: alias_config
      changed_when: false

    - name: Get DHCP server configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          $dhcp = array();
          if (isset($config['dhcpd'])) {
            foreach ($config['dhcpd'] as $iface => $dhcpconf) {
              $dhcp[$iface] = array(
                'enable' => isset($dhcpconf['enable']),
                'range_from' => isset($dhcpconf['range']['from']) ? $dhcpconf['range']['from'] : '',
                'range_to' => isset($dhcpconf['range']['to']) ? $dhcpconf['range']['to'] : '',
                'gateway' => isset($dhcpconf['gateway']) ? $dhcpconf['gateway'] : '',
                'domain' => isset($dhcpconf['domain']) ? $dhcpconf['domain'] : '',
                'dnsserver' => isset($dhcpconf['dnsserver']) ? $dhcpconf['dnsserver'] : array(),
                'defaultleasetime' => isset($dhcpconf['defaultleasetime']) ? $dhcpconf['defaultleasetime'] : '',
                'maxleasetime' => isset($dhcpconf['maxleasetime']) ? $dhcpconf['maxleasetime'] : ''
              );
            }
          }
          echo json_encode($dhcp);
      register: dhcp_config
      changed_when: false

    - name: Get DHCP static leases
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          $statics = array();
          if (isset($config['dhcpd'])) {
            foreach ($config['dhcpd'] as $iface => $dhcpconf) {
              if (isset($dhcpconf['staticmap'])) {
                foreach ($dhcpconf['staticmap'] as $static) {
                  $statics[] = array(
                    'interface' => $iface,
                    'mac' => isset($static['mac']) ? $static['mac'] : '',
                    'ipaddr' => isset($static['ipaddr']) ? $static['ipaddr'] : '',
                    'hostname' => isset($static['hostname']) ? $static['hostname'] : '',
                    'descr' => isset($static['descr']) ? $static['descr'] : ''
                  );
                }
              }
            }
          }
          echo json_encode($statics);
      register: dhcp_static_config
      changed_when: false

    - name: Get firewall rules
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          $rules = array();
          if (isset($config['filter']['rule'])) {
            foreach ($config['filter']['rule'] as $rule) {
              $rules[] = array(
                'interface' => isset($rule['interface']) ? $rule['interface'] : '',
                'type' => isset($rule['type']) ? $rule['type'] : 'pass',
                'ipprotocol' => isset($rule['ipprotocol']) ? $rule['ipprotocol'] : 'inet',
                'protocol' => isset($rule['protocol']) ? $rule['protocol'] : 'any',
                'source' => isset($rule['source']) ? $rule['source'] : array(),
                'destination' => isset($rule['destination']) ? $rule['destination'] : array(),
                'descr' => isset($rule['descr']) ? $rule['descr'] : '',
                'disabled' => isset($rule['disabled']),
                'log' => isset($rule['log']),
                'floating' => isset($rule['floating'])
              );
            }
          }
          echo json_encode($rules);
      register: firewall_rules_config
      changed_when: false

    - name: Get CARP/VHID configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          $carp = array();
          if (isset($config['virtualip']['vip'])) {
            foreach ($config['virtualip']['vip'] as $vip) {
              if (isset($vip['mode']) && $vip['mode'] == 'carp') {
                $carp[] = array(
                  'interface' => isset($vip['interface']) ? $vip['interface'] : '',
                  'vhid' => isset($vip['vhid']) ? $vip['vhid'] : '',
                  'advskew' => isset($vip['advskew']) ? $vip['advskew'] : '',
                  'advbase' => isset($vip['advbase']) ? $vip['advbase'] : '',
                  'subnet' => isset($vip['subnet']) ? $vip['subnet'] : '',
                  'subnet_bits' => isset($vip['subnet_bits']) ? $vip['subnet_bits'] : '',
                  'descr' => isset($vip['descr']) ? $vip['descr'] : ''
                );
              }
            }
          }
          echo json_encode($carp);
      register: carp_config
      changed_when: false

    - name: Get HA sync configuration
      pfsensible.core.pfsense_phpshell:
        cmd: |
          global $config;
          $hasync = array();
          if (isset($config['hasync'])) {
            $hasync = array(
              'pfsyncenabled' => isset($config['hasync']['pfsyncenabled']),
              'pfsyncpeerip' => isset($config['hasync']['pfsyncpeerip']) ? $config['hasync']['pfsyncpeerip'] : '',
              'pfsyncinterface' => isset($config['hasync']['pfsyncinterface']) ? $config['hasync']['pfsyncinterface'] : '',
              'synchronizetoip' => isset($config['hasync']['synchronizetoip']) ? $config['hasync']['synchronizetoip'] : '',
              'username' => isset($config['hasync']['username']) ? $config['hasync']['username'] : ''
            );
          }
          echo json_encode($hasync);
      register: hasync_config
      changed_when: false

    - name: Parse configurations
      ansible.builtin.set_fact:
        pfsense_system: "{{ system_config.stdout_lines[-1] | from_json }}"
        pfsense_interfaces: "{{ interface_config.stdout_lines[-1] | from_json }}"
        pfsense_vlans: "{{ vlan_config.stdout_lines[-1] | from_json }}"
        pfsense_aliases: "{{ alias_config.stdout_lines[-1] | from_json }}"
        pfsense_dhcp: "{{ dhcp_config.stdout_lines[-1] | from_json }}"
        pfsense_dhcp_static: "{{ dhcp_static_config.stdout_lines[-1] | from_json }}"
        pfsense_firewall_rules: "{{ firewall_rules_config.stdout_lines[-1] | from_json }}"
        pfsense_carp: "{{ carp_config.stdout_lines[-1] | from_json }}"
        pfsense_hasync: "{{ hasync_config.stdout_lines[-1] | from_json }}"

    - name: Display configuration summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          pfSense Golden Config from {{ inventory_hostname }}
          ═══════════════════════════════════════════════════════════
          System: {{ pfsense_system.hostname }}.{{ pfsense_system.domain }}
          Interfaces: {{ pfsense_interfaces | length }}
          VLANs: {{ pfsense_vlans | length }}
          Aliases: {{ pfsense_aliases | length }}
          DHCP Servers: {{ pfsense_dhcp | length }}
          Static Leases: {{ pfsense_dhcp_static | length }}
          Firewall Rules: {{ pfsense_firewall_rules | length }}
          CARP VIPs: {{ pfsense_carp | length }}
          HA Sync: {{ 'Enabled' if pfsense_hasync.pfsyncenabled | default(false) else 'Disabled' }}

    - name: Write golden config
      ansible.builtin.copy:
        content: |
          # pfSense Golden Configuration
          # Pulled from: {{ inventory_hostname }}
          # Pull date: {{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}
          ---
          pfsense_golden_config:
            _meta:
              source: "{{ inventory_hostname }}"
              pulled_at: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

            system:
          {{ pfsense_system | to_nice_yaml(indent=2) | indent(4, first=true) }}
            interfaces:
          {{ pfsense_interfaces | to_nice_yaml(indent=2) | indent(4, first=true) }}
            vlans:
          {{ pfsense_vlans | to_nice_yaml(indent=2) | indent(4, first=true) }}
            aliases:
          {{ pfsense_aliases | to_nice_yaml(indent=2) | indent(4, first=true) }}
            dhcp:
          {{ pfsense_dhcp | to_nice_yaml(indent=2) | indent(4, first=true) }}
            dhcp_static_leases:
          {{ pfsense_dhcp_static | to_nice_yaml(indent=2) | indent(4, first=true) }}
            firewall_rules:
          {{ pfsense_firewall_rules | to_nice_yaml(indent=2) | indent(4, first=true) }}
            carp:
          {{ pfsense_carp | to_nice_yaml(indent=2) | indent(4, first=true) }}
            hasync:
          {{ pfsense_hasync | to_nice_yaml(indent=2) | indent(4, first=true) }}
        dest: "{{ output_file }}"
      delegate_to: localhost

